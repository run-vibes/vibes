<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>vibes :: firehose — CRT Essence v4</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=VT323&family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    /* ═══════════════════════════════════════════════════════════════
       CRT ESSENCE V4 — With CMD+K command palette modal
       ═══════════════════════════════════════════════════════════════ */

    :root {
      --phosphor: #ffb000;
      --phosphor-bright: #ffc940;
      --phosphor-dim: #996a00;
      --phosphor-faint: #4d3500;
      --phosphor-glow: rgba(255, 176, 0, 0.4);
      --phosphor-subtle: rgba(255, 176, 0, 0.15);

      --screen: #0a0908;
      --screen-light: #141210;
      --screen-lighter: #1e1a16;

      --red: #ff4444;
      --green: #44ff44;
      --cyan: #44ffff;

      --font-display: 'VT323', monospace;
      --font-mono: 'IBM Plex Mono', monospace;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      background: var(--screen);
      overflow: hidden;
    }

    body {
      font-family: var(--font-mono);
      color: var(--phosphor);
    }

    /* ═══ SCANLINES ═══ */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background: repeating-linear-gradient(
        0deg,
        rgba(0,0,0,0.15) 0px,
        rgba(0,0,0,0.15) 1px,
        transparent 1px,
        transparent 2px
      );
      pointer-events: none;
      z-index: 1000;
    }

    /* ═══ SCREEN VIGNETTE ═══ */
    body::after {
      content: '';
      position: fixed;
      inset: 0;
      background: radial-gradient(
        ellipse at center,
        transparent 0%,
        transparent 60%,
        rgba(0,0,0,0.4) 100%
      );
      pointer-events: none;
      z-index: 999;
    }

    /* ═══ GLOW UTILITIES ═══ */
    .glow {
      text-shadow:
        0 0 2px var(--phosphor),
        0 0 8px var(--phosphor-glow),
        0 0 16px var(--phosphor-subtle);
    }

    .glow-bright {
      text-shadow:
        0 0 2px var(--phosphor-bright),
        0 0 10px var(--phosphor),
        0 0 25px var(--phosphor-glow),
        0 0 40px var(--phosphor-subtle);
    }

    .glow-red {
      color: var(--red);
      text-shadow: 0 0 4px var(--red), 0 0 12px rgba(255,68,68,0.5);
    }

    .glow-green {
      color: var(--green);
      text-shadow: 0 0 4px var(--green), 0 0 12px rgba(68,255,68,0.5);
    }

    .glow-cyan {
      color: var(--cyan);
      text-shadow: 0 0 4px var(--cyan), 0 0 12px rgba(68,255,255,0.5);
    }

    /* ═══ LAYOUT ═══ */
    .app {
      display: grid;
      grid-template-rows: auto 1fr;
      height: 100vh;
      padding: 1rem;
      gap: 0.5rem;
    }

    /* ═══ HEADER ═══ */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1rem;
      border: 1px solid var(--phosphor-faint);
      background: var(--screen-light);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 1.5rem;
    }

    .logo {
      font-family: var(--font-display);
      font-size: 2rem;
      letter-spacing: 0.15em;
    }

    .nav {
      display: flex;
      gap: 0.25rem;
    }

    .nav-item {
      padding: 0.375rem 0.75rem;
      font-family: var(--font-display);
      font-size: 1.25rem;
      color: var(--phosphor-dim);
      cursor: pointer;
      transition: all 0.15s;
      border: 1px solid transparent;
    }

    .nav-item:hover {
      color: var(--phosphor);
      text-shadow: 0 0 8px var(--phosphor-glow);
    }

    .nav-item.active {
      color: var(--phosphor);
      border-color: var(--phosphor-dim);
      background: var(--phosphor-subtle);
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 1.5rem;
    }

    .header-action {
      font-family: var(--font-display);
      font-size: 1.125rem;
      color: var(--phosphor-dim);
      cursor: pointer;
      padding: 0.25rem 0.5rem;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .header-action:hover {
      color: var(--phosphor);
      text-shadow: 0 0 8px var(--phosphor-glow);
    }

    .theme-icon {
      font-size: 1rem;
    }

    .settings-icon {
      font-size: 1.25rem;
    }

    /* ═══ MAIN — 4 COLUMN LAYOUT ═══ */
    .main {
      display: grid;
      grid-template-columns: 160px 200px 1fr 320px;
      gap: 0.5rem;
      overflow: hidden;
    }

    /* ═══ SESSION TABS ═══ */
    .session-tabs {
      display: flex;
      flex-direction: column;
      border: 1px solid var(--phosphor-faint);
      background: var(--screen-light);
      overflow: hidden;
    }

    .session-tabs-header {
      padding: 0.5rem 0.75rem;
      font-family: var(--font-display);
      font-size: 1rem;
      letter-spacing: 0.1em;
      border-bottom: 1px solid var(--phosphor-faint);
      color: var(--phosphor-dim);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .session-count {
      font-size: 0.875rem;
      color: var(--phosphor);
    }

    .session-list {
      flex: 1;
      overflow-y: auto;
    }

    .session-item {
      padding: 0.625rem 0.75rem;
      border-bottom: 1px solid var(--phosphor-faint);
      cursor: pointer;
      transition: all 0.1s;
      position: relative;
    }

    .session-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: transparent;
      transition: background 0.1s;
    }

    .session-item:hover {
      background: var(--phosphor-subtle);
    }

    .session-item.selected {
      background: var(--phosphor-subtle);
    }

    .session-item.selected::before {
      background: var(--phosphor);
      box-shadow: 0 0 6px var(--phosphor-glow);
    }

    .session-id {
      font-family: var(--font-display);
      font-size: 1.125rem;
      color: var(--phosphor);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .session-checkbox {
      width: 12px;
      height: 12px;
      border: 1px solid var(--phosphor-dim);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
    }

    .session-item.selected .session-checkbox {
      background: var(--phosphor);
      color: var(--screen);
      border-color: var(--phosphor);
    }

    .session-name {
      font-size: 0.75rem;
      color: var(--phosphor-dim);
      margin-top: 0.125rem;
    }

    .session-meta {
      font-size: 0.625rem;
      color: var(--phosphor-faint);
      margin-top: 0.25rem;
      display: flex;
      gap: 0.5rem;
    }

    .session-status {
      display: inline-block;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      margin-right: 0.25rem;
    }

    .session-status.active { background: var(--green); box-shadow: 0 0 4px var(--green); }
    .session-status.stale { background: var(--phosphor-dim); }
    .session-status.error { background: var(--red); box-shadow: 0 0 4px var(--red); }

    /* ═══ SIDEBAR ═══ */
    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      overflow-y: auto;
    }

    .panel {
      border: 1px solid var(--phosphor-faint);
      background: var(--screen-light);
    }

    .panel-header {
      padding: 0.5rem 0.75rem;
      font-family: var(--font-display);
      font-size: 1rem;
      letter-spacing: 0.1em;
      border-bottom: 1px solid var(--phosphor-faint);
      color: var(--phosphor-dim);
    }

    .panel-body {
      padding: 0.75rem;
    }

    .stat-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.5rem;
    }

    .stat {
      text-align: center;
      padding: 0.5rem;
      border: 1px solid var(--phosphor-faint);
    }

    .stat-value {
      font-family: var(--font-display);
      font-size: 1.75rem;
      line-height: 1;
    }

    .stat-label {
      font-size: 0.5625rem;
      color: var(--phosphor-dim);
      letter-spacing: 0.1em;
      margin-top: 0.25rem;
    }

    .sparkline {
      font-family: var(--font-display);
      font-size: 1.125rem;
      letter-spacing: -0.05em;
      color: var(--phosphor-dim);
      text-align: center;
      padding: 0.375rem 0;
    }

    .sparkline .peak {
      color: var(--phosphor);
      text-shadow: 0 0 6px var(--phosphor-glow);
    }

    .filter-list {
      display: flex;
      flex-direction: column;
      gap: 0.125rem;
    }

    .filter-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.3125rem 0.5rem;
      font-family: var(--font-display);
      font-size: 0.9375rem;
      cursor: pointer;
      border: 1px solid transparent;
      transition: all 0.1s;
    }

    .filter-item:hover {
      border-color: var(--phosphor-faint);
      background: var(--phosphor-subtle);
    }

    .filter-item.active {
      border-color: var(--phosphor-dim);
      background: var(--phosphor-subtle);
    }

    .filter-count {
      font-size: 0.8125rem;
      color: var(--phosphor-dim);
    }

    /* ═══ STREAM ═══ */
    .stream {
      display: flex;
      flex-direction: column;
      border: 1px solid var(--phosphor-faint);
      background: var(--screen-light);
      overflow: hidden;
    }

    .stream-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.5rem 1rem;
      border-bottom: 1px solid var(--phosphor-faint);
    }

    .stream-title {
      font-family: var(--font-display);
      font-size: 1.25rem;
      letter-spacing: 0.1em;
    }

    .stream-status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-family: var(--font-display);
      font-size: 1rem;
      cursor: pointer;
      padding: 0.25rem 0.5rem;
      border: 1px solid transparent;
      transition: all 0.15s;
    }

    .stream-status:hover {
      border-color: var(--phosphor-faint);
    }

    .stream-status.live { color: var(--red); }
    .stream-status.paused { color: var(--phosphor-dim); }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      transition: all 0.15s;
    }

    .stream-status.live .status-dot {
      background: var(--red);
      box-shadow: 0 0 6px var(--red), 0 0 12px rgba(255,68,68,0.4);
      animation: pulse 1s ease-in-out infinite;
    }

    .stream-status.paused .status-dot {
      background: var(--phosphor-dim);
      box-shadow: none;
      animation: none;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .stream-body {
      flex: 1;
      overflow-y: auto;
      font-family: var(--font-mono);
      font-size: 0.8125rem;
    }

    .event-row {
      display: grid;
      grid-template-columns: 90px 60px 1fr 60px;
      gap: 0.75rem;
      padding: 0.5rem 1rem;
      border-bottom: 1px solid var(--phosphor-faint);
      transition: background 0.1s;
      cursor: pointer;
    }

    .event-row:hover { background: var(--phosphor-subtle); }

    .event-row.selected {
      background: var(--phosphor-subtle);
      border-left: 2px solid var(--phosphor);
      padding-left: calc(1rem - 2px);
    }

    .event-time {
      color: var(--phosphor-dim);
      font-variant-numeric: tabular-nums;
      font-size: 0.75rem;
    }

    .event-type {
      font-family: var(--font-display);
      font-size: 0.875rem;
      text-transform: uppercase;
    }

    .event-type.tool { color: var(--phosphor); }
    .event-type.claude { color: var(--phosphor-bright); text-shadow: 0 0 6px var(--phosphor-glow); }
    .event-type.session { color: var(--cyan); text-shadow: 0 0 6px rgba(68,255,255,0.4); }
    .event-type.hook { color: var(--phosphor-dim); }
    .event-type.assess { color: #ffd700; text-shadow: 0 0 6px rgba(255,215,0,0.4); }
    .event-type.error { color: var(--red); text-shadow: 0 0 6px rgba(255,68,68,0.4); }

    .event-content {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .event-session {
      color: var(--phosphor-dim);
      font-variant-numeric: tabular-nums;
      text-align: right;
      font-size: 0.75rem;
    }

    /* ═══ EVENT DETAILS PANEL ═══ */
    .event-details {
      display: flex;
      flex-direction: column;
      border: 1px solid var(--phosphor-faint);
      background: var(--screen-light);
      overflow: hidden;
    }

    .event-details.empty {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .empty-message {
      text-align: center;
      color: var(--phosphor-dim);
      font-family: var(--font-display);
      font-size: 1.25rem;
    }

    .empty-hint {
      font-size: 0.875rem;
      margin-top: 0.5rem;
      color: var(--phosphor-faint);
    }

    .details-header {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--phosphor-faint);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .details-title {
      font-family: var(--font-display);
      font-size: 1.25rem;
      letter-spacing: 0.1em;
    }

    .details-close {
      font-family: var(--font-display);
      font-size: 1.25rem;
      color: var(--phosphor-dim);
      cursor: pointer;
      padding: 0 0.5rem;
      transition: color 0.1s;
    }

    .details-close:hover { color: var(--phosphor); }

    .details-body {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
    }

    .detail-section { margin-bottom: 1.25rem; }

    .detail-label {
      font-family: var(--font-display);
      font-size: 0.875rem;
      color: var(--phosphor-dim);
      letter-spacing: 0.1em;
      margin-bottom: 0.375rem;
    }

    .detail-value {
      font-size: 0.875rem;
      color: var(--phosphor);
      word-break: break-all;
    }

    .detail-value.large {
      font-family: var(--font-display);
      font-size: 1.5rem;
    }

    .detail-value.mono {
      font-family: var(--font-mono);
      font-size: 0.75rem;
      padding: 0.75rem;
      background: var(--screen);
      border: 1px solid var(--phosphor-faint);
      white-space: pre-wrap;
      max-height: 200px;
      overflow-y: auto;
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 0.375rem 0;
      border-bottom: 1px dashed var(--phosphor-faint);
    }

    .detail-row:last-child { border-bottom: none; }

    .detail-key { color: var(--phosphor-dim); font-size: 0.75rem; }
    .detail-val { color: var(--phosphor); font-size: 0.75rem; font-variant-numeric: tabular-nums; }

    /* ═══ HOTKEY HINT ═══ */
    .hotkey-hint {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      font-family: var(--font-display);
      font-size: 0.875rem;
      color: var(--phosphor-faint);
      z-index: 100;
      display: flex;
      gap: 1.25rem;
    }

    .hotkey-hint span {
      display: flex;
      align-items: center;
      gap: 0.375rem;
    }

    .hotkey-key {
      color: var(--phosphor-dim);
      padding: 0.125rem 0.375rem;
      border: 1px solid var(--phosphor-faint);
      font-size: 0.75rem;
    }

    /* ═══════════════════════════════════════════════════════════════
       COMMAND PALETTE MODAL
       ═══════════════════════════════════════════════════════════════ */

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.75);
      z-index: 2000;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding-top: 10vh;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.15s, visibility 0.15s;
    }

    .modal-backdrop.open {
      opacity: 1;
      visibility: visible;
    }

    .command-palette {
      width: 100%;
      max-width: 640px;
      background: var(--screen);
      border: 2px solid var(--phosphor-dim);
      box-shadow:
        0 0 20px var(--phosphor-glow),
        0 0 60px rgba(255, 176, 0, 0.15),
        inset 0 0 80px rgba(255, 176, 0, 0.03);
      transform: translateY(-20px) scale(0.95);
      transition: transform 0.15s;
      display: flex;
      flex-direction: column;
      max-height: 70vh;
    }

    .modal-backdrop.open .command-palette {
      transform: translateY(0) scale(1);
    }

    /* Palette header */
    .palette-header {
      display: flex;
      align-items: center;
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--phosphor-faint);
      gap: 0.75rem;
    }

    .palette-prompt {
      font-family: var(--font-display);
      font-size: 1.75rem;
      color: var(--phosphor);
      text-shadow: 0 0 8px var(--phosphor-glow);
    }

    .palette-input {
      flex: 1;
      background: transparent;
      border: none;
      font-family: var(--font-mono);
      font-size: 1rem;
      color: var(--phosphor);
      outline: none;
      caret-color: var(--phosphor);
    }

    .palette-input::placeholder {
      color: var(--phosphor-faint);
    }

    .palette-close {
      font-family: var(--font-display);
      font-size: 1rem;
      color: var(--phosphor-faint);
      cursor: pointer;
      padding: 0.25rem 0.5rem;
      border: 1px solid var(--phosphor-faint);
      transition: all 0.1s;
    }

    .palette-close:hover {
      color: var(--phosphor);
      border-color: var(--phosphor-dim);
    }

    /* Response area */
    .palette-response {
      flex: 1;
      overflow-y: auto;
      padding: 1rem 1.25rem;
      font-family: var(--font-mono);
      font-size: 0.875rem;
      line-height: 1.6;
      min-height: 200px;
      max-height: 400px;
    }

    .response-empty {
      color: var(--phosphor-faint);
      font-family: var(--font-display);
      font-size: 1rem;
      text-align: center;
      padding: 2rem;
    }

    .response-empty .commands-hint {
      margin-top: 1.5rem;
      text-align: left;
      font-size: 0.875rem;
    }

    .response-empty .cmd-row {
      display: flex;
      gap: 1rem;
      padding: 0.375rem 0;
      border-bottom: 1px dashed var(--phosphor-faint);
    }

    .response-empty .cmd-name {
      color: var(--phosphor);
      min-width: 120px;
    }

    .response-empty .cmd-desc {
      color: var(--phosphor-faint);
    }

    /* Streaming response */
    .response-content {
      color: var(--phosphor);
    }

    .response-content .user-msg {
      color: var(--phosphor-dim);
      margin-bottom: 0.75rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px dashed var(--phosphor-faint);
    }

    .response-content .user-msg::before {
      content: '> ';
      color: var(--phosphor);
    }

    .response-content .ai-msg {
      color: var(--phosphor);
      white-space: pre-wrap;
    }

    .response-content .ai-msg.streaming::after {
      content: '█';
      animation: blink 0.5s step-end infinite;
      color: var(--phosphor);
      text-shadow: 0 0 8px var(--phosphor-glow);
    }

    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0; }
    }

    /* Palette footer */
    .palette-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 1.25rem;
      border-top: 1px solid var(--phosphor-faint);
      font-family: var(--font-display);
      font-size: 0.75rem;
      color: var(--phosphor-faint);
    }

    .palette-footer .hint-key {
      color: var(--phosphor-dim);
      padding: 0.125rem 0.25rem;
      border: 1px solid var(--phosphor-faint);
      margin-right: 0.25rem;
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Header -->
    <header class="header">
      <div class="header-left">
        <span class="logo glow-bright">VIBES</span>
        <nav class="nav">
          <span class="nav-item">DASH</span>
          <span class="nav-item">SESS</span>
          <span class="nav-item active">FIRE</span>
          <span class="nav-item">GROOVE</span>
        </nav>
      </div>
      <div class="header-right">
        <span class="header-action" id="theme-toggle" title="Toggle theme">
          <span class="theme-icon">◐</span>
          <span>THEME</span>
        </span>
        <span class="header-action" id="settings-link" title="Settings">
          <span class="settings-icon">⚙</span>
          <span>SETTINGS</span>
        </span>
      </div>
    </header>

    <!-- Main -->
    <main class="main">
      <!-- Session Tabs -->
      <aside class="session-tabs">
        <div class="session-tabs-header">
          <span>SESSIONS</span>
          <span class="session-count" id="session-count">2/5</span>
        </div>
        <div class="session-list" id="session-list">
          <div class="session-item selected" data-session="a7f3c2">
            <div class="session-id"><span class="session-checkbox">✓</span> a7f3c2</div>
            <div class="session-name">api-refactor</div>
            <div class="session-meta"><span><span class="session-status active"></span>active</span><span>47 evt</span></div>
          </div>
          <div class="session-item selected" data-session="b2e1d4">
            <div class="session-id"><span class="session-checkbox">✓</span> b2e1d4</div>
            <div class="session-name">bug-fix-auth</div>
            <div class="session-meta"><span><span class="session-status active"></span>active</span><span>23 evt</span></div>
          </div>
          <div class="session-item" data-session="c9d4e5">
            <div class="session-id"><span class="session-checkbox"></span> c9d4e5</div>
            <div class="session-name">perf-testing</div>
            <div class="session-meta"><span><span class="session-status stale"></span>stale</span><span>89 evt</span></div>
          </div>
          <div class="session-item" data-session="d8e2f1">
            <div class="session-id"><span class="session-checkbox"></span> d8e2f1</div>
            <div class="session-name">docs-update</div>
            <div class="session-meta"><span><span class="session-status stale"></span>closed</span><span>12 evt</span></div>
          </div>
          <div class="session-item" data-session="e1a3b7">
            <div class="session-id"><span class="session-checkbox"></span> e1a3b7</div>
            <div class="session-name">feature-xyz</div>
            <div class="session-meta"><span><span class="session-status error"></span>error</span><span>156 evt</span></div>
          </div>
        </div>
      </aside>

      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="panel">
          <div class="panel-header">METRICS</div>
          <div class="panel-body">
            <div class="stat-grid">
              <div class="stat"><div class="stat-value glow">1247</div><div class="stat-label">EVT/HR</div></div>
              <div class="stat"><div class="stat-value glow-green">3</div><div class="stat-label">ACTIVE</div></div>
              <div class="stat"><div class="stat-value glow">47</div><div class="stat-label">LEARNS</div></div>
              <div class="stat"><div class="stat-value glow-red">2</div><div class="stat-label">ERRORS</div></div>
            </div>
            <div class="sparkline">▁▂▃▂<span class="peak">▅▇█</span>▆▄▃▂▁▂▃</div>
          </div>
        </div>
        <div class="panel">
          <div class="panel-header">FILTER</div>
          <div class="panel-body">
            <div class="filter-list">
              <div class="filter-item active"><span>ALL</span><span class="filter-count">847</span></div>
              <div class="filter-item"><span>TOOL</span><span class="filter-count">312</span></div>
              <div class="filter-item"><span>CLAUDE</span><span class="filter-count">284</span></div>
              <div class="filter-item"><span>SESSION</span><span class="filter-count">127</span></div>
              <div class="filter-item"><span>HOOK</span><span class="filter-count">89</span></div>
              <div class="filter-item"><span>ASSESS</span><span class="filter-count">33</span></div>
              <div class="filter-item"><span>ERROR</span><span class="filter-count">2</span></div>
            </div>
          </div>
        </div>
      </aside>

      <!-- Stream -->
      <section class="stream">
        <div class="stream-header">
          <span class="stream-title glow">EVENT STREAM</span>
          <div class="stream-status live" id="stream-status" title="Click to toggle">
            <span class="status-dot"></span>
            <span class="status-text">LIVE</span>
          </div>
        </div>
        <div class="stream-body" id="stream-body"></div>
      </section>

      <!-- Event Details Panel -->
      <aside class="event-details empty" id="event-details">
        <div class="empty-message">
          <div>SELECT EVENT</div>
          <div class="empty-hint">Click an event to view details</div>
        </div>
      </aside>
    </main>
  </div>

  <!-- Hotkey hints -->
  <div class="hotkey-hint">
    <span><span class="hotkey-key">⌘K</span> command</span>
    <span><span class="hotkey-key">?</span> help</span>
  </div>

  <!-- Command Palette Modal -->
  <div class="modal-backdrop" id="command-modal">
    <div class="command-palette">
      <div class="palette-header">
        <span class="palette-prompt">⟩</span>
        <input type="text" class="palette-input" id="palette-input" placeholder="Ask a question or type a command..." autofocus>
        <span class="palette-close" id="palette-close">ESC</span>
      </div>
      <div class="palette-response" id="palette-response">
        <div class="response-empty">
          <div>Type a message or command</div>
          <div class="commands-hint">
            <div class="cmd-row"><span class="cmd-name">/sessions</span><span class="cmd-desc">List active sessions</span></div>
            <div class="cmd-row"><span class="cmd-name">/filter &lt;type&gt;</span><span class="cmd-desc">Filter events by type</span></div>
            <div class="cmd-row"><span class="cmd-name">/export</span><span class="cmd-desc">Export current view</span></div>
            <div class="cmd-row"><span class="cmd-name">/clear</span><span class="cmd-desc">Clear event stream</span></div>
            <div class="cmd-row"><span class="cmd-name">/help</span><span class="cmd-desc">Show all commands</span></div>
          </div>
        </div>
      </div>
      <div class="palette-footer">
        <span><span class="hint-key">↵</span> send</span>
        <span><span class="hint-key">ESC</span> close</span>
      </div>
    </div>
  </div>

  <script>
    // ═══════════════════════════════════════════════════════════════
    // COMMAND PALETTE
    // ═══════════════════════════════════════════════════════════════

    const modal = document.getElementById('command-modal');
    const paletteInput = document.getElementById('palette-input');
    const paletteResponse = document.getElementById('palette-response');
    let conversationHistory = [];

    function openPalette() {
      modal.classList.add('open');
      paletteInput.focus();
      paletteInput.value = '';
    }

    function closePalette() {
      modal.classList.remove('open');
      // Reset after animation
      setTimeout(function() {
        if (!modal.classList.contains('open')) {
          conversationHistory = [];
          renderEmptyState();
        }
      }, 200);
    }

    function renderEmptyState() {
      while (paletteResponse.firstChild) {
        paletteResponse.removeChild(paletteResponse.firstChild);
      }

      const empty = document.createElement('div');
      empty.className = 'response-empty';

      const title = document.createElement('div');
      title.textContent = 'Type a message or command';
      empty.appendChild(title);

      const hints = document.createElement('div');
      hints.className = 'commands-hint';

      const commands = [
        { name: '/sessions', desc: 'List active sessions' },
        { name: '/filter <type>', desc: 'Filter events by type' },
        { name: '/export', desc: 'Export current view' },
        { name: '/clear', desc: 'Clear event stream' },
        { name: '/help', desc: 'Show all commands' }
      ];

      commands.forEach(function(cmd) {
        const row = document.createElement('div');
        row.className = 'cmd-row';

        const nameEl = document.createElement('span');
        nameEl.className = 'cmd-name';
        nameEl.textContent = cmd.name;

        const descEl = document.createElement('span');
        descEl.className = 'cmd-desc';
        descEl.textContent = cmd.desc;

        row.appendChild(nameEl);
        row.appendChild(descEl);
        hints.appendChild(row);
      });

      empty.appendChild(hints);
      paletteResponse.appendChild(empty);
    }

    function renderConversation() {
      while (paletteResponse.firstChild) {
        paletteResponse.removeChild(paletteResponse.firstChild);
      }

      const content = document.createElement('div');
      content.className = 'response-content';

      conversationHistory.forEach(function(msg, idx) {
        const msgEl = document.createElement('div');
        msgEl.className = msg.role === 'user' ? 'user-msg' : 'ai-msg';

        if (msg.role === 'ai' && idx === conversationHistory.length - 1 && msg.streaming) {
          msgEl.classList.add('streaming');
        }

        msgEl.textContent = msg.content;
        content.appendChild(msgEl);
      });

      paletteResponse.appendChild(content);
      paletteResponse.scrollTop = paletteResponse.scrollHeight;
    }

    // Simulated streaming response
    function simulateResponse(userMsg) {
      conversationHistory.push({ role: 'user', content: userMsg });
      conversationHistory.push({ role: 'ai', content: '', streaming: true });
      renderConversation();

      // Determine response based on input
      let fullResponse = '';

      if (userMsg.startsWith('/')) {
        const cmd = userMsg.split(' ')[0].toLowerCase();
        switch (cmd) {
          case '/sessions':
            fullResponse = 'Active sessions:\n\n• a7f3c2 (api-refactor) — 47 events, running\n• b2e1d4 (bug-fix-auth) — 23 events, running\n• c9d4e5 (perf-testing) — 89 events, stale';
            break;
          case '/filter':
            const filterType = userMsg.split(' ')[1] || 'all';
            fullResponse = 'Filter applied: ' + filterType.toUpperCase() + '\n\nShowing ' + (filterType === 'all' ? '847' : Math.floor(Math.random() * 300 + 50)) + ' events matching filter.';
            break;
          case '/export':
            fullResponse = 'Exporting current view...\n\nGenerated: firehose-export-2024-01-15-143022.json\nEvents: 847\nSize: 2.4 MB\n\n✓ Export complete. File saved to ~/Downloads/';
            break;
          case '/clear':
            fullResponse = '✓ Event stream cleared.\n\nNew events will continue to appear as they arrive.';
            break;
          case '/help':
            fullResponse = 'Available commands:\n\n/sessions — List active sessions\n/filter <type> — Filter by event type\n/export — Export current view\n/clear — Clear event stream\n/theme — Toggle light/dark theme\n/help — Show this help\n\nOr just ask a question in natural language!';
            break;
          default:
            fullResponse = 'Unknown command: ' + cmd + '\n\nType /help to see available commands.';
        }
      } else {
        // Natural language responses
        const responses = [
          'Based on the current session data, I can see that the api-refactor session has been the most active with 47 tool invocations. The majority are file reads and writes, suggesting active development work.',
          'Looking at the event stream, there have been 2 errors in the last hour. Both appear to be WebSocket timeouts, which might indicate network instability or server load issues.',
          'The assessment system has captured 47 learnings so far. The most common patterns are around test-first methodology (appearing in 60% of sessions) and error-handling improvements.',
          'I can help you analyze the event patterns. What specifically would you like to know? I can look at error rates, tool usage patterns, session activity, or learning captures.'
        ];
        fullResponse = responses[Math.floor(Math.random() * responses.length)];
      }

      // Stream the response character by character
      let charIndex = 0;
      const streamInterval = setInterval(function() {
        if (charIndex < fullResponse.length) {
          conversationHistory[conversationHistory.length - 1].content += fullResponse[charIndex];
          charIndex++;
          renderConversation();
        } else {
          conversationHistory[conversationHistory.length - 1].streaming = false;
          renderConversation();
          clearInterval(streamInterval);
        }
      }, 15);
    }

    function handleSubmit() {
      const value = paletteInput.value.trim();
      if (!value) return;

      paletteInput.value = '';
      simulateResponse(value);
    }

    // Event listeners
    document.addEventListener('keydown', function(e) {
      // CMD+K or CTRL+K to open
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        if (modal.classList.contains('open')) {
          closePalette();
        } else {
          openPalette();
        }
      }

      // ESC to close
      if (e.key === 'Escape' && modal.classList.contains('open')) {
        closePalette();
      }
    });

    paletteInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        handleSubmit();
      }
    });

    document.getElementById('palette-close').addEventListener('click', closePalette);

    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        closePalette();
      }
    });

    // ═══════════════════════════════════════════════════════════════
    // STREAM & EVENT HANDLING (same as v3)
    // ═══════════════════════════════════════════════════════════════

    let isLive = true;
    let userScrolled = false;

    const eventTypes = ['tool', 'claude', 'session', 'hook', 'assess', 'error'];
    const eventContents = {
      tool: [
        { content: 'Read file: src/lib/types.ts', details: { file: 'src/lib/types.ts', bytes: 1204, duration: '12ms' }},
        { content: 'Write file: tests/unit/auth.spec.ts', details: { file: 'tests/unit/auth.spec.ts', bytes: 847, duration: '8ms' }},
        { content: 'Bash: cargo test --lib', details: { command: 'cargo test --lib', exit: 0, duration: '4.2s' }},
        { content: 'Edit: vibes-core/src/session.rs:142-156', details: { file: 'vibes-core/src/session.rs', lines: '142-156', bytes: 312 }},
      ],
      claude: [
        { content: 'Analyzing type definitions for refactoring...', details: { model: 'claude-3-opus', tokens: 1247, thinking: true }},
        { content: 'Implementing fix for session reconnection logic...', details: { model: 'claude-3-opus', tokens: 892, thinking: false }},
        { content: 'Reviewing test coverage for auth module...', details: { model: 'claude-3-opus', tokens: 567, thinking: true }},
      ],
      session: [
        { content: 'Session heartbeat: active, 47 tools invoked', details: { tools: 47, uptime: '1h 23m', memory: '124MB' }},
        { content: 'Session checkpoint saved', details: { checkpoint: 'ckpt_847a2', size: '2.1MB' }},
      ],
      hook: [
        { content: 'pre-commit hook executed: lint passed', details: { hook: 'pre-commit', duration: '1.2s', exit: 0 }},
        { content: 'post-save hook executed: format complete', details: { hook: 'post-save', duration: '340ms', exit: 0 }},
      ],
      assess: [
        { content: 'Learning captured: test-first methodology (0.94)', details: { pattern: 'test-first', confidence: 0.94, category: 'methodology' }},
        { content: 'Pattern recognized: error-handling-improvement (0.89)', details: { pattern: 'error-handling', confidence: 0.89, category: 'quality' }},
      ],
      error: [
        { content: 'ABEND: WebSocket connection timeout after 30s', details: { error: 'TIMEOUT', code: 'WS_TIMEOUT', retry: true }},
        { content: 'ERROR: Failed to parse response JSON', details: { error: 'PARSE_ERROR', code: 'JSON_INVALID', recoverable: false }},
      ]
    };

    const sessions = ['a7f3c2', 'b2e1d4', 'c9d4e5'];
    let eventId = 0;

    function createEventRow(time, type, contentObj, session) {
      const row = document.createElement('div');
      row.className = 'event-row';
      row.dataset.eventId = ++eventId;
      row.dataset.type = type;
      row.dataset.content = contentObj.content;
      row.dataset.details = JSON.stringify(contentObj.details);
      row.dataset.time = time;
      row.dataset.session = session;

      const timeSpan = document.createElement('span');
      timeSpan.className = 'event-time';
      timeSpan.textContent = time;

      const typeSpan = document.createElement('span');
      typeSpan.className = 'event-type ' + type;
      typeSpan.textContent = type.toUpperCase();

      const contentSpan = document.createElement('span');
      contentSpan.className = 'event-content';
      contentSpan.textContent = contentObj.content;

      const sessionSpan = document.createElement('span');
      sessionSpan.className = 'event-session';
      sessionSpan.textContent = session;

      row.appendChild(timeSpan);
      row.appendChild(typeSpan);
      row.appendChild(contentSpan);
      row.appendChild(sessionSpan);

      row.addEventListener('click', function() { selectEvent(row); });

      return row;
    }

    function buildDetailsPanel(row) {
      const detailsPanel = document.getElementById('event-details');
      detailsPanel.classList.remove('empty');

      while (detailsPanel.firstChild) {
        detailsPanel.removeChild(detailsPanel.firstChild);
      }

      const header = document.createElement('div');
      header.className = 'details-header';

      const title = document.createElement('span');
      title.className = 'details-title glow';
      title.textContent = 'EVENT DETAILS';

      const closeBtn = document.createElement('span');
      closeBtn.className = 'details-close';
      closeBtn.textContent = '×';
      closeBtn.addEventListener('click', closeDetails);

      header.appendChild(title);
      header.appendChild(closeBtn);
      detailsPanel.appendChild(header);

      const body = document.createElement('div');
      body.className = 'details-body';

      // Type
      const typeSection = document.createElement('div');
      typeSection.className = 'detail-section';
      const typeLabel = document.createElement('div');
      typeLabel.className = 'detail-label';
      typeLabel.textContent = 'TYPE';
      const typeValue = document.createElement('div');
      typeValue.className = 'detail-value large';
      typeValue.textContent = row.dataset.type.toUpperCase();
      typeSection.appendChild(typeLabel);
      typeSection.appendChild(typeValue);
      body.appendChild(typeSection);

      // Timestamp
      const timeSection = document.createElement('div');
      timeSection.className = 'detail-section';
      const timeLabel = document.createElement('div');
      timeLabel.className = 'detail-label';
      timeLabel.textContent = 'TIMESTAMP';
      const timeValue = document.createElement('div');
      timeValue.className = 'detail-value';
      timeValue.textContent = row.dataset.time;
      timeSection.appendChild(timeLabel);
      timeSection.appendChild(timeValue);
      body.appendChild(timeSection);

      // Session
      const sessSection = document.createElement('div');
      sessSection.className = 'detail-section';
      const sessLabel = document.createElement('div');
      sessLabel.className = 'detail-label';
      sessLabel.textContent = 'SESSION';
      const sessValue = document.createElement('div');
      sessValue.className = 'detail-value';
      sessValue.textContent = row.dataset.session;
      sessSection.appendChild(sessLabel);
      sessSection.appendChild(sessValue);
      body.appendChild(sessSection);

      // Content
      const contentSection = document.createElement('div');
      contentSection.className = 'detail-section';
      const contentLabel = document.createElement('div');
      contentLabel.className = 'detail-label';
      contentLabel.textContent = 'CONTENT';
      const contentValue = document.createElement('div');
      contentValue.className = 'detail-value mono';
      contentValue.textContent = row.dataset.content;
      contentSection.appendChild(contentLabel);
      contentSection.appendChild(contentValue);
      body.appendChild(contentSection);

      // Metadata
      const details = JSON.parse(row.dataset.details);
      const metaSection = document.createElement('div');
      metaSection.className = 'detail-section';
      const metaLabel = document.createElement('div');
      metaLabel.className = 'detail-label';
      metaLabel.textContent = 'METADATA';
      metaSection.appendChild(metaLabel);

      for (const [key, val] of Object.entries(details)) {
        const detailRow = document.createElement('div');
        detailRow.className = 'detail-row';

        const keySpan = document.createElement('span');
        keySpan.className = 'detail-key';
        keySpan.textContent = key;

        const valSpan = document.createElement('span');
        valSpan.className = 'detail-val';
        valSpan.textContent = String(val);

        detailRow.appendChild(keySpan);
        detailRow.appendChild(valSpan);
        metaSection.appendChild(detailRow);
      }

      body.appendChild(metaSection);
      detailsPanel.appendChild(body);
    }

    function selectEvent(row) {
      document.querySelectorAll('.event-row.selected').forEach(function(r) {
        r.classList.remove('selected');
      });
      row.classList.add('selected');
      buildDetailsPanel(row);
    }

    function closeDetails() {
      const detailsPanel = document.getElementById('event-details');
      detailsPanel.classList.add('empty');

      while (detailsPanel.firstChild) {
        detailsPanel.removeChild(detailsPanel.firstChild);
      }

      const emptyMsg = document.createElement('div');
      emptyMsg.className = 'empty-message';

      const mainText = document.createElement('div');
      mainText.textContent = 'SELECT EVENT';

      const hintText = document.createElement('div');
      hintText.className = 'empty-hint';
      hintText.textContent = 'Click an event to view details';

      emptyMsg.appendChild(mainText);
      emptyMsg.appendChild(hintText);
      detailsPanel.appendChild(emptyMsg);

      document.querySelectorAll('.event-row.selected').forEach(function(r) {
        r.classList.remove('selected');
      });
    }

    function updateStreamStatus() {
      const statusEl = document.getElementById('stream-status');
      const textEl = statusEl.querySelector('.status-text');

      if (isLive) {
        statusEl.classList.remove('paused');
        statusEl.classList.add('live');
        textEl.textContent = 'LIVE';
      } else {
        statusEl.classList.remove('live');
        statusEl.classList.add('paused');
        textEl.textContent = 'PAUSED';
      }
    }

    // Initialize stream
    const stream = document.getElementById('stream-body');
    const now = new Date();

    for (let i = 0; i < 12; i++) {
      const type = eventTypes[Math.floor(Math.random() * (eventTypes.length - 1))];
      const contents = eventContents[type];
      const contentObj = contents[Math.floor(Math.random() * contents.length)];
      const session = sessions[Math.floor(Math.random() * sessions.length)];
      const time = new Date(now - (i * 3000));
      const timeStr = time.toTimeString().split(' ')[0] + '.' + String(time.getMilliseconds()).padStart(3, '0');

      stream.appendChild(createEventRow(timeStr, type, contentObj, session));
    }

    stream.addEventListener('scroll', function() {
      const isAtTop = stream.scrollTop < 10;

      if (isAtTop && !isLive) {
        isLive = true;
        userScrolled = false;
        updateStreamStatus();
      } else if (!isAtTop && isLive) {
        isLive = false;
        userScrolled = true;
        updateStreamStatus();
      }
    });

    document.getElementById('stream-status').addEventListener('click', function() {
      isLive = !isLive;
      if (isLive) {
        stream.scrollTop = 0;
      }
      updateStreamStatus();
    });

    setInterval(function() {
      if (!isLive) return;

      const type = eventTypes[Math.floor(Math.random() * eventTypes.length)];
      const contents = eventContents[type];
      const contentObj = contents[Math.floor(Math.random() * contents.length)];
      const session = sessions[Math.floor(Math.random() * sessions.length)];
      const now = new Date();
      const timeStr = now.toTimeString().split(' ')[0] + '.' + String(now.getMilliseconds()).padStart(3, '0');

      const row = createEventRow(timeStr, type, contentObj, session);
      stream.insertBefore(row, stream.firstChild);

      if (stream.children.length > 20) {
        stream.removeChild(stream.lastChild);
      }
    }, 2500);

    document.getElementById('session-list').addEventListener('click', function(e) {
      const item = e.target.closest('.session-item');
      if (!item) return;

      item.classList.toggle('selected');
      const checkbox = item.querySelector('.session-checkbox');
      checkbox.textContent = item.classList.contains('selected') ? '✓' : '';

      const total = document.querySelectorAll('.session-item').length;
      const selected = document.querySelectorAll('.session-item.selected').length;
      document.getElementById('session-count').textContent = selected + '/' + total;
    });
  </script>
</body>
</html>
